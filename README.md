# KV Storage

## Сборка

```bash
git submodule update --init --recursive
mkdir build
cd build
cmake 
make
.\kv_storage_tests.exe  
```


## Асимптотика операций

| Метод                | Средний случай        
|----------------------|-----------------------
| **Set**              | `O(log n)`
| **Remove**           | `O(log n)`
| **Get**              | `O(1)`
| **GetManySorted**    | `O(log n) + count`
| **RemoveOneExpired** | `O(log n)`


## Примечания

- Для быстрого поиска по ключу используется мапа (амортизированно `O(1)`).
- Для упорядоченного доступа по ключам используется сет
- Для удаления по TTL используется мин куча
- Все операции гарантируют отсутствие UB при рехеше благодаря хранению только ключей в структурах, которые не инвалидируются при изменениях.

## Покрытие тестами

Тесты проверяют:

1. **Get** — возврат существующих и отсутствующих ключей.
2. **Set** — добавление новых и обновление существующих ключей.
3. **Remove** — удаление существующих и несуществующих ключей.
4. **GetManySorted** — корректность выборки диапазонов в отсортированном порядке.
5. **TTL**:
   - Удаление элементов по истечении времени.
   - Поведение при изменении TTL существующего ключа.
   - Ситуацию, когда истёкших элементов нет.
6. **Пустое хранилище** — корректная работа всех методов без элементов.
7. **RemoveOneExpired + Remove** — ситуация, когда ключ удалён вручную до истечения TTL.
8. **Отсортированное хранилище** — проверка корректности порядка при нестандартной инициализации.


## Оверхед 

32 +(размер key) + 32+(размер value) + 8 (expire_time) = 72 байта


Узел unordered_map :
- Ключ (std::string): 32 байта (SSO) + размер ключа.
- Значение (Entry): value (std::string, 32 байта) + expire_time (Clock::time_point, 8 байт).
- Указатель на следующий узел (при коллизиях): 8 байт.
- Хэш ключа: 8 байт.


Узел set :
- Ключ (std::string): 32 байта + размер ключа.
- Указатели (левый, правый, родитель): 8 * 3 = 24 байта.
- Цвет узла: 1 байт (выравнивание до 8 байт).


Мин куча 

Элемент priority_queue (ExpireRecord):
- expire_time (Clock::time_point): 8 байт.
- Ключ (std::string): 32 байта + размер ключа.
### Итого 

#### unordered_map: 88 + key.size() + value.size()

#### set:           64 + key.size() 

#### priority_queue:40 + key.size() 